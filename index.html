<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Sellables — Sheets + imgbb</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-indigo-50 via-white to-white text-slate-900">
  <div id="root" class="max-w-6xl mx-auto p-4"></div>

  <!-- React + ReactDOM + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useEffect, useMemo, useState, useRef } = React;

    // ====== CONFIG ======
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyhObJKHsYMwoIN00Cl5thzoUhu5QdMXGGQsZsUYqP_jIAioVq9ejhCzTiXM3NLp2Zl/exec";
    const IMGBB_API_KEY   = "5ea85e510c18117d8d7648fb2e08b551";

    // ====== Helpers ======
    function fmtUSD(n){ try { return new Intl.NumberFormat(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}).format(Number(n)||0); } catch { return "$"+Math.round(Number(n)||0); } }
    function formatCurrency(usd, currency, rate){
      const num = Number(usd)||0;
      if(currency==="USD") return fmtUSD(num);
      return (Math.round(num*rate)||0).toLocaleString()+" LBP";
    }
    const Button = ({children,onClick,variant="primary",size="md",className="",type="button",disabled})=>{
      const base="inline-flex items-center justify-center rounded-lg font-medium transition disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2";
      const sizes={sm:"px-3 py-1.5 text-sm",md:"px-4 py-2 text-sm",lg:"px-5 py-2.5 text-base"};
      const variants={
        primary:"bg-indigo-600 text-white hover:bg-indigo-500 focus:ring-indigo-300",
        secondary:"bg-white border border-slate-300 text-slate-800 hover:bg-slate-50 focus:ring-slate-300",
        ghost:"bg-transparent text-slate-700 hover:bg-slate-100",
        danger:"bg-rose-600 text-white hover:bg-rose-500 focus:ring-rose-300",
        success:"bg-emerald-600 text-white hover:bg-emerald-500 focus:ring-emerald-300"
      };
      return <button type={type} onClick={onClick} disabled={disabled} className={[base,sizes[size],variants[variant],className].join(" ")}>{children}</button>;
    };
    const Input = React.forwardRef((props, ref)=>(<input ref={ref} {...props} className={"w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300 "+(props.className||"")}/>));
    const Select = ({value,onChange,children,className})=><select value={value} onChange={(e)=>onChange(e.target.value)} className={"w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-300 "+(className||"")}>{children}</select>;
    const Badge = ({status})=>{
      const map={ "For Sale":"bg-indigo-600 text-white","Reserved":"bg-amber-100 text-amber-800","Sold":"bg-slate-100 text-slate-700 border border-slate-300","Draft":"bg-rose-100 text-rose-800" };
      const cls = map[status]||"bg-slate-100 text-slate-800";
      return <span className={"px-2.5 py-1 text-xs rounded-full "+cls}>{status}</span>;
    };

    // ====== Networking ======
    async function parseJSONResponse(res){ const text=await res.text(); let json=null; try{json=JSON.parse(text);}catch{} return {httpOk:res.ok,status:res.status,statusText:res.statusText,text,json}; }
    async function gsList(){ const r=await parseJSONResponse(await fetch(APPS_SCRIPT_URL)); if(!r.httpOk||!r.json) throw new Error(`GET ${r.status} ${r.statusText}: ${r.text}`); return r.json.data||[]; }
    async function gsAdd(row){ const r=await parseJSONResponse(await fetch(APPS_SCRIPT_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action:"add",data:row})})); if(!r.httpOk||!r.json?.ok) throw new Error(r.json?.error||`ADD ${r.status}: ${r.text}`); return r.json; }
    async function gsUpdate(row){ const r=await parseJSONResponse(await fetch(APPS_SCRIPT_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action:"update",data:row})})); if(!r.httpOk||!r.json?.ok) throw new Error(r.json?.error||`UPDATE ${r.status}: ${r.text}`); return r.json; }
    async function gsDelete(id){ const r=await parseJSONResponse(await fetch(APPS_SCRIPT_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action:"delete",id})})); if(!r.httpOk||!r.json?.ok) throw new Error(r.json?.error||`DELETE ${r.status}: ${r.text}`); return r.json; }
    async function gsTxAdd(data){ const r=await parseJSONResponse(await fetch(APPS_SCRIPT_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({action:"tx_add",data})})); if(!r.httpOk||!r.json?.ok) throw new Error(r.json?.error||`TX ${r.status}: ${r.text}`); return r.json; }
    async function gsTxList(){ const r=await parseJSONResponse(await fetch(APPS_SCRIPT_URL+"?action=tx_list")); if(!r.httpOk||!r.json) throw new Error(`TX LIST ${r.status}: ${r.text}`); return r.json.data||[]; }

    // Upload to imgbb
    function fileToBase64(file){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(String(r.result).split(",")[1]); r.onerror=reject; r.readAsDataURL(file); }); }
    async function uploadToImgbb(file){ const b64=await fileToBase64(file); const form=new FormData(); form.append("image",b64); const r=await parseJSONResponse(await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:form})); const url=r.json?.data?.url; if(!url) throw new Error(`imgbb failed: ${r.status} ${r.text}`); return url; }

    // Mapping
    const HEADERS={
      id:["ID"], name:["Name"], priceUSD:["Price_USD","Price USD"], priceLBP:["Price_LBP","Price LBP"],
      category:["Category"], status:["Status"], image:["Image_URL","Image URL"], createdAt:["CreatedAt","Created"],
      quantity:["Quantity","Qty","Stock"]
    };
    const g=(row,keys)=>{ for(const k of keys){ if(row[k]!=null && row[k]!=="") return row[k]; } return ""; };
    const safe=(row)=>{ const id=String(g(row,HEADERS.id)).trim(); const name=String(g(row,HEADERS.name)).trim(); if(!name) return null; if(!id) return {skip:true};
      return { id, name, usd:Number(g(row,HEADERS.priceUSD))||0, category:String(g(row,HEADERS.category)||"Other"), status:String(g(row,HEADERS.status)||"For Sale"), image:String(g(row,HEADERS.image)||""), createdAt:String(g(row,HEADERS.createdAt)||new Date().toISOString()), qty:Number(g(row,HEADERS.quantity))||0 };
    };

    // ====== App ======
    const CATEGORIES=["Electronics","Gaming","Home","Fashion","Kids","Sports","Other"];
    const STATUSES=["Draft","For Sale","Reserved","Sold"];

    function App(){
      const [items,setItems]=useState([]);
      const [loading,setLoading]=useState(true);
      const [error,setError]=useState("");
      const [query,setQuery]=useState("");
      const [statusFilter,setStatusFilter]=useState("All");
      const [categoryFilter,setCategoryFilter]=useState("All");
      const [sortBy,setSortBy]=useState("newest");
      const [currency,setCurrency]=useState(localStorage.getItem("sellables-currency")||"USD");
      const [rate,setRate]=useState(Number(localStorage.getItem("sellables-rate")||90000));
      const [justAdded,setJustAdded]=useState(null);
      const [txOpen,setTxOpen]=useState(false);
      const [txRows,setTxRows]=useState([]);

      useEffect(()=>{ localStorage.setItem("sellables-currency",currency); },[currency]);
      useEffect(()=>{ localStorage.setItem("sellables-rate",String(rate)); },[rate]);

      async function load(){
        try{
          setLoading(true);
          const raw=await gsList();
          const mapped=[];
          for(const r of raw){ const m=safe(r); if(!m||m.skip) continue; mapped.push(m); }
          setItems(mapped);
          setError("");
        }catch(e){ setError(String(e)); }
        finally{ setLoading(false); }
      }
      useEffect(()=>{ load(); },[]);

      const filtered=useMemo(()=>{
        const q=query.trim().toLowerCase();
        let list=items.filter(it=>[it.name,it.category,it.status].some(f=>(f||"").toLowerCase().includes(q)));
        if(statusFilter!=="All") list=list.filter(it=>it.status===statusFilter);
        if(categoryFilter!=="All") list=list.filter(it=>it.category===categoryFilter);
        const cmp={ "price-asc":(a,b)=>a.usd-b.usd,"price-desc":(a,b)=>b.usd-a.usd,"name":(a,b)=>a.name.localeCompare(b.name),"newest":(a,b)=>new Date(b.createdAt)-new Date(a.createdAt) }[sortBy]||(()=>0);
        return [...list].sort(cmp);
      },[items,query,statusFilter,categoryFilter,sortBy]);

      async function addItem(local){
        try{
          let imageURL=local.imageURL||"";
          if(local.file) imageURL=await uploadToImgbb(local.file);
          const row={ Name:local.name, Price_LBP:currency==="LBP"?Number(local.price):Math.round(Number(local.price)*rate), Price_USD:currency==="USD"?Number(local.price):Number(local.price)/rate, Category:local.category, Status:local.status, Image_URL:imageURL, Quantity:Number(local.quantity)||0 };
          await gsAdd(row);
          await load();
          setJustAdded({ name:row.Name, usd:row.Price_USD, image:imageURL });
        }catch(e){ alert("Add failed: "+e.message); }
      }

      async function saveItem(updated){
        try{ const row={ID:updated.id,Name:updated.name,Price_LBP:Math.round(updated.usd*rate),Price_USD:updated.usd,Category:updated.category,Status:updated.status,Image_URL:updated.image,Quantity:updated.qty}; await gsUpdate(row); await load(); }
        catch(e){ alert("Save failed: "+e.message); }
      }

      async function deleteItem(id){
        if(!confirm("Delete this item?")) return;
        try{ await gsDelete(id); setItems(prev=>prev.filter(x=>x.id!==id)); }
        catch(e){ alert("Delete failed: "+e.message); }
      }

      function shareWhatsApp(item){
        const price = formatCurrency(item.usd, currency, rate);
        const lines=[`*${item.name}*`,`Price: ${price}`,`Stock: ${item.qty}`,item.category?`Category: ${item.category}`:null,item.image?`Image: ${item.image}`:null].filter(Boolean);
        window.open("https://wa.me/?text="+encodeURIComponent(lines.join("\n")),"_blank");
      }

      async function openTransactions(){
        try{
          setTxOpen(true);
          const rows = await gsTxList();
          setTxRows(rows.reverse()); // latest first
        }catch(e){ alert("Load transactions failed: "+e.message); }
      }

      return (
        <div>
          <header className="sticky top-0 z-30 backdrop-blur bg-white/70 border-b">
            <div className="px-2 py-3 flex flex-wrap gap-3 items-center">
              <div className="flex items-center gap-2">
                <div className="w-8 h-8 rounded-lg bg-indigo-600"></div>
                <h1 className="text-xl font-semibold">Sellables</h1>
              </div>
              <div className="ml-auto flex items-center gap-2">
                <Select value={currency} onChange={setCurrency} className="w-[110px]">
                  <option value="USD">USD</option><option value="LBP">LBP</option>
                </Select>
                <div className="flex items-center gap-2 flex-wrap">
                   <span className="text-base font-semibold text-slate-800">Rate</span>
                  <Input
    type="number"
    value={rate}
    onChange={e=>setRate(Number(e.target.value)||0)}
    className="w-[160px] text-lg font-semibold"
  />
                </div>
                <Button variant="secondary" onClick={openTransactions}>Transactions</Button>
                <NewItemFancy onAdd={addItem} currency={currency} rate={rate}/>
                <Button variant="secondary" onClick={load}>Refresh</Button>
              </div>
            </div>
          </header>

          <main className="py-4">
            <div className="border rounded-2xl bg-white p-3 mb-4 shadow-sm">
              <div className="grid grid-cols-1 md:grid-cols-12 gap-3">
                <div className="md:col-span-6"><Input placeholder="Search…" value={query} onChange={e=>setQuery(e.target.value)} /></div>
                <div className="md:col-span-2"><Select value={statusFilter} onChange={setStatusFilter}><option>All</option>{STATUSES.map(s=><option key={s}>{s}</option>)}</Select></div>
                <div className="md:col-span-2"><Select value={categoryFilter} onChange={setCategoryFilter}><option>All</option>{CATEGORIES.map(c=><option key={c}>{c}</option>)}</Select></div>
                <div className="md:col-span-2"><Select value={sortBy} onChange={setSortBy}><option value="newest">Newest</option><option value="name">Name</option><option value="price-asc">Price ↑</option><option value="price-desc">Price ↓</option></Select></div>
              </div>
            </div>

            {loading ? <div className="p-4 text-slate-600">Loading…</div> :
             error ? <div className="p-4 text-red-600 whitespace-pre-wrap">{error}</div> :
             <Grid items={filtered} currency={currency} rate={rate} onSave={saveItem} onDelete={deleteItem} onShare={shareWhatsApp} onTxLogged={load} />}
          </main>

          {/* Transactions Drawer */}
          {txOpen && (
            <div className="fixed inset-0 z-50 bg-black/40" onClick={()=>setTxOpen(false)}>
              <div className="absolute right-0 top-0 bottom-0 w-full max-w-2xl bg-white shadow-2xl" onClick={e=>e.stopPropagation()}>
                <div className="p-4 border-b flex items-center justify-between">
                  <div className="font-semibold text-lg">Transactions</div>
                  <Button variant="secondary" onClick={()=>setTxOpen(false)}>Close</Button>
                </div>
                <div className="p-4 overflow-auto h-full">
                  {txRows.length===0 ? <div className="text-slate-600">No transactions yet.</div> : (
                    <table className="min-w-full text-sm">
                      <thead className="text-left text-slate-600">
                        <tr>
                          <th className="py-2 pr-3">Time</th>
                          <th className="py-2 pr-3">Item</th>
                          <th className="py-2 pr-3">Type</th>
                          <th className="py-2 pr-3">Qty</th>
                          <th className="py-2 pr-3">Unit $</th>
                          <th className="py-2 pr-3">Total $</th>
                          <th className="py-2 pr-3">Stock</th>
                          <th className="py-2">Note</th>
                        </tr>
                      </thead>
                      <tbody>
                        {txRows.map((r,i)=>(
                          <tr key={i} className="border-t">
                            <td className="py-2 pr-3">{new Date(r.Timestamp).toLocaleString()}</td>
                            <td className="py-2 pr-3">{r.ItemName}</td>
                            <td className="py-2 pr-3 capitalize">{r.Type}</td>
                            <td className="py-2 pr-3">{r.Qty}</td>
                            <td className="py-2 pr-3">{fmtUSD(r.UnitUSD)}</td>
                            <td className="py-2 pr-3">{fmtUSD(r.TotalUSD)}</td>
                            <td className="py-2 pr-3">{r.NewQty}</td>
                            <td className="py-2">{r.Note||""}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ====== Add Item Modal (with Quantity) ======
    function NewItemFancy({ onAdd, currency, rate }){
      const [open,setOpen]=useState(false);
      const [form,setForm]=useState({ name:"", price:"", category:"Electronics", status:"For Sale", imageURL:"", file:null, quantity:0 });
      const [busy,setBusy]=useState(false);
      const [err,setErr]=useState("");
      const dropRef = useRef(null);
      const nameRef = useRef(null);
      function update(k,v){ setForm(f=>({...f,[k]:v})); }

      useEffect(()=>{ if(open) nameRef.current?.focus(); },[open]);
      useEffect(()=>{
        if(!open) return;
        const onKey=(e)=>{ if(e.key==="Escape") setOpen(false); if(e.key==="Enter" && !busy) submit(); };
        window.addEventListener("keydown", onKey);
        return ()=>window.removeEventListener("keydown", onKey);
      },[open,busy]);
      useEffect(()=>{ if(!open) return; const prev=document.body.style.overflow; document.body.style.overflow="hidden"; return ()=>{ document.body.style.overflow=prev; }; },[open]);

      useEffect(()=>{
        const el=dropRef.current; if(!el) return;
        const prevent=e=>{e.preventDefault(); e.stopPropagation();};
        const over=e=>{prevent(e); el.classList.add("ring-2","ring-indigo-300");};
        const leave=e=>{prevent(e); el.classList.remove("ring-2","ring-indigo-300");};
        const drop=e=>{prevent(e); el.classList.remove("ring-2","ring-indigo-300"); if(e.dataTransfer.files?.[0]) update("file", e.dataTransfer.files[0]);};
        ["dragenter","dragover"].forEach(t=>el.addEventListener(t,over)); ["dragleave","dragend"].forEach(t=>el.addEventListener(t,leave)); el.addEventListener("drop",drop);
        return ()=>{ ["dragenter","dragover"].forEach(t=>el.removeEventListener(t,over)); ["dragleave","dragend"].forEach(t=>el.removeEventListener(t,leave)); el.removeEventListener("drop",drop); };
      },[]);

      const otherPreview = React.useMemo(()=>{
        if(form.price===""||isNaN(Number(form.price))) return "";
        if(currency==="USD"){ return Math.round(Number(form.price)*rate).toLocaleString()+" LBP"; }
        return fmtUSD(Number(form.price)/rate);
      },[form.price,currency,rate]);

      async function submit(){
        try{
          setBusy(true); setErr("");
          if(!form.name.trim()) throw new Error("Please enter a name");
          const priceNum = Number(form.price);
          if(form.price===""||isNaN(priceNum)) throw new Error("Please enter a valid price");
          if(priceNum < 0) throw new Error("Price must be ≥ 0");
          if(Number(form.quantity) < 0) throw new Error("Quantity must be ≥ 0");
          await onAdd(form);
          setForm({ name:"", price:"", category:"Electronics", status:"For Sale", imageURL:"", file:null, quantity:0 });
          setOpen(false);
        }catch(e){ setErr(e.message); }
        finally{ setBusy(false); }
      }

      return (
        <>
          <Button onClick={()=>setOpen(true)}>Add item</Button>
          {open && (
            <div className="fixed inset-0 z-50 bg-black/40 flex items-start justify-center pt-24" onClick={()=>!busy && setOpen(false)}>
              <div className="bg-white rounded-2xl w-full max-w-4xl overflow-hidden shadow-2xl" onClick={e=>e.stopPropagation()}>
                <div className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-4">
                  <div className="text-lg font-semibold">Add a new item</div>
                  <div className="text-white/80 text-sm">Fill the details below. Upload a photo or paste a link.</div>
                </div>

                <div className="p-6 max-h-[70dvh] sm:max-h-[70vh] overflow-auto">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="space-y-4">
                      <div className="bg-slate-50 border border-slate-200 rounded-xl p-4">
                        <div className="text-sm font-semibold text-slate-700 mb-3">Basics</div>
                        <div className="space-y-3">
                          <div>
                            <label className="text-sm text-slate-600">Name</label>
                            <Input ref={nameRef} value={form.name} onChange={e=>update("name", e.target.value)} placeholder="e.g. iPhone 12, 128GB" />
                          </div>
                          <div className="grid grid-cols-2 gap-3">
                            <div>
                              <label className="text-sm text-slate-600">Category</label>
                              <Select value={form.category} onChange={v=>update("category", v)}>{["Electronics","Gaming","Home","Fashion","Kids","Sports","Other"].map(c=><option key={c}>{c}</option>)}</Select>
                            </div>
                            <div>
                              <label className="text-sm text-slate-600">Status</label>
                              <Select value={form.status} onChange={v=>update("status", v)}>{["For Sale","Reserved","Sold","Draft"].map(s=><option key={s}>{s}</option>)}</Select>
                            </div>
                          </div>
                          <div>
                            <label className="text-sm text-slate-600">Quantity in stock</label>
                            <Input type="number" value={form.quantity} onChange={e=>update("quantity", e.target.value)} placeholder="0" />
                          </div>
                        </div>
                      </div>

                      <div className="bg-slate-50 border border-slate-200 rounded-xl p-4">
                        <div className="text-sm font-semibold text-slate-700 mb-3">Pricing</div>
                        <div className="grid grid-cols-2 gap-3 items-end">
                          <div>
                            <label className="text-sm text-slate-600">Price ({currency})</label>
                            <Input type="number" value={form.price} onChange={e=>update("price", e.target.value)} placeholder={currency==="USD"?"50":"4500000"} />
                            <div className="mt-2 inline-block px-2 py-1 rounded-md bg-indigo-50 text-indigo-700 text-sm font-semibold">Rate: {rate.toLocaleString()} LBP / $</div>
                          </div>
                          <div className="text-sm text-slate-600">
                            <div className="text-xs mb-1">Converted</div>
                            <div className="h-[38px] flex items-center rounded-lg border border-slate-300 px-3 bg-white">
                              <span className="text-slate-800">{otherPreview || "—"}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div className="space-y-4">
                      <div className="bg-slate-50 border border-slate-200 rounded-xl p-4">
                        <div className="text-sm font-semibold text-slate-700 mb-3">Image</div>
                        <div className="grid gap-3">
                          <div>
                            <label className="text-sm text-slate-600">Image URL</label>
                            <Input value={form.imageURL} onChange={e=>update("imageURL", e.target.value)} placeholder="https://…" />
                          </div>
                          <div ref={dropRef} className="rounded-xl border-2 border-dashed border-slate-300 bg-white p-4 text-center">
                            <div className="text-sm text-slate-600 mb-2">Drag & drop a photo here, or</div>
                            <label className="inline-block">
                              <input type="file" accept="image/*" className="hidden" onChange={e=>update("file", e.target.files?.[0]||null)} />
                              <span className="cursor-pointer inline-flex items-center px-3 py-1.5 rounded-md border border-slate-300 text-sm bg-white hover:bg-slate-50">Choose File</span>
                            </label>
                            <div className="text-xs text-slate-500 mt-2">Uploads go to imgbb.</div>
                          </div>
                          <div className="aspect-video rounded-lg overflow-hidden bg-slate-100 flex items-center justify-center">
                            {form.file ? <img src={URL.createObjectURL(form.file)} className="w-full h-full object-cover" /> :
                             (form.imageURL ? <img src={form.imageURL} className="w-full h-full object-cover" /> : <div className="text-slate-400 text-sm">Preview will appear here</div>)}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  {err && <div className="mt-4 text-rose-600 text-sm">{err}</div>}
                </div>

                <div className="px-6 py-4 border-t bg-white flex justify-end gap-2 sticky bottom-0 sm:static">
                  <Button variant="secondary" onClick={()=>setOpen(false)} disabled={busy}>Cancel</Button>
                  <Button onClick={submit} disabled={busy}>{busy?"Saving…":"Save item"}</Button>
                </div>
              </div>
            </div>
          )}
        </>
      );
    }

    function Grid({ items, currency, rate, onSave, onDelete, onShare, onTxLogged }){
      if(!items.length) return <div className="text-slate-600 p-6 bg-white rounded-2xl border shadow-sm">No items yet. Click <span className="font-semibold">Add item</span> to start.</div>;
      return (
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
          {items.map(it=><Card key={it.id} item={it} currency={currency} rate={rate} onSave={onSave} onDelete={onDelete} onShare={onShare} onTxLogged={onTxLogged} />)}
        </div>
      );
    }

    function Card({ item, currency, rate, onSave, onDelete, onShare, onTxLogged }){
      const [open,setOpen]=useState(false);
      const [form,setForm]=useState(item);
      const [localPrice,setLocalPrice]=useState(currency==="USD"?item.usd:Math.round(item.usd*rate));
      const [busy,setBusy]=useState(false);
      const [txOpen,setTxOpen]=useState(false);

      useEffect(()=>{ setForm(item); setLocalPrice(currency==="USD"?item.usd:Math.round(item.usd*rate)); },[item.id,currency,rate]);

      async function handleUpload(file){
        if(!file) return;
        setBusy(true);
        try{ const url=await uploadToImgbb(file); setForm(f=>({...f,image:url})); }
        catch(e){ alert("Upload failed: "+e.message); }
        finally{ setBusy(false); }
      }
      async function submit(){
        setBusy(true);
        const usd = currency==="USD"?Number(localPrice):Number(localPrice)/rate;
        await onSave({...form, usd});
        setBusy(false); setOpen(false);
      }

      return (
        <div className="rounded-2xl overflow-hidden border bg-white shadow-sm">
          <div className="aspect-video bg-slate-100 flex items-center justify-center">
            {item.image ? <img src={item.image} className="w-full h-full object-cover" /> : <div className="text-slate-400">No image</div>}
          </div>
          <div className="p-4">
            <div className="flex items-center justify-between">
              <div className="font-semibold truncate">{item.name}</div>
              <Badge status={item.status}/>
            </div>
            <div className="mt-1 text-sm text-slate-600 flex items-center justify-between">
              <span>{item.category}</span>
              <span className="font-medium">{formatCurrency(item.usd, currency, rate)}</span>
            </div>
            <div className="mt-2 text-xs">
              {item.qty > 0
                ? <span className="px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">Stock: {item.qty}</span>
                : <span className="px-2 py-1 rounded-full bg-rose-50 text-rose-700 border border-rose-200">Out of stock</span>
              }
            </div>
          </div>
          <div className="p-3 border-t flex items-center justify-between">
            <div className="flex gap-2">
              <Button variant="success" size="sm" onClick={()=>onShare(item)}>WhatsApp</Button>
              <Button variant="secondary" size="sm" onClick={()=>setOpen(true)}>Edit</Button>
              <Button variant="primary" size="sm" onClick={()=>setTxOpen(true)}>Log Txn</Button>
            </div>
            <Button variant="danger" size="sm" onClick={()=>onDelete(item.id)}>Delete</Button>
          </div>

          {/* Edit modal */}
          {open && (
            <div className="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4" onClick={()=>!busy && setOpen(false)}>
              <div className="bg-white rounded-2xl w-full max-w-3xl overflow-hidden shadow-2xl" onClick={e=>e.stopPropagation()}>
                <div className="px-6 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold">Edit item</div>
                <div className="p-6 max-h-[70vh] overflow-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-3">
                    <div><label className="text-sm text-slate-600">Name</label><Input value={form.name} onChange={e=>setForm(f=>({...f,name:e.target.value}))}/></div>
                    <div><label className="text-sm text-slate-600">Price ({currency})</label><Input type="number" value={localPrice} onChange={e=>setLocalPrice(e.target.value)}/></div>
                    <div className="grid grid-cols-2 gap-3">
                      <div><label className="text-sm text-slate-600">Category</label><Select value={form.category} onChange={v=>setForm(f=>({...f,category:v}))}>{["Electronics","Gaming","Home","Fashion","Kids","Sports","Other"].map(c=><option key={c}>{c}</option>)}</Select></div>
                      <div><label className="text-sm text-slate-600">Status</label><Select value={form.status} onChange={v=>setForm(f=>({...f,status:v}))}>{["For Sale","Reserved","Sold","Draft"].map(s=><option key={s}>{s}</option>)}</Select></div>
                    </div>
                    <div><label className="text-sm text-slate-600">Quantity</label><Input type="number" value={form.qty} onChange={e=>setForm(f=>({...f,qty:Number(e.target.value)||0}))}/></div>
                  </div>
                  <div className="space-y-3">
                    <div><label className="text-sm text-slate-600">Image URL</label><Input value={form.image||""} onChange={e=>setForm(f=>({...f,image:e.target.value}))}/></div>
                    <div>
                      <label className="text-sm text-slate-600">Or Upload</label>
                      <input type="file" accept="image/*" className="block w-full text-sm" onChange={e=>handleUpload(e.target.files?.[0]||null)} />
                    </div>
                    <div className="aspect-video rounded-lg overflow-hidden bg-slate-100 flex items-center justify-center">
                      {form.image ? <img src={form.image} className="w-full h-full object-cover" /> : <div className="text-slate-400">Preview</div>}
                    </div>
                  </div>
                </div>
                <div className="px-6 py-4 border-t flex justify-end gap-2">
                  <Button variant="secondary" onClick={()=>setOpen(false)} disabled={busy}>Cancel</Button>
                  <Button onClick={submit} disabled={busy}>{busy?"Saving…":"Save"}</Button>
                </div>
              </div>
            </div>
          )}

          {/* Log transaction modal */}
          {txOpen && (
            <TxnModal
              item={item}
              onClose={()=>setTxOpen(false)}
              onSaved={async()=>{ setTxOpen(false); await onTxLogged(); }}
            />
          )}
        </div>
      );
    }

    function TxnModal({ item, onClose, onSaved }){
      const [type,setType]=useState("sale"); // or purchase
      const [qty,setQty]=useState(1);
      const [price,setPrice]=useState(item.usd);
      const [note,setNote]=useState("");
      const [busy,setBusy]=useState(false);

      async function submit(){
        try{
          setBusy(true);
          if(qty<=0) throw new Error("Qty must be > 0");
          await gsTxAdd({ itemId:item.id, type, qty:Number(qty), unitUsd:Number(price), note });
          await onSaved();
        }catch(e){ alert("Transaction failed: "+e.message); }
        finally{ setBusy(false); }
      }

      return (
        <div className="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4" onClick={()=>!busy && onClose()}>
          <div className="bg-white rounded-2xl w-full max-w-md overflow-hidden shadow-2xl" onClick={e=>e.stopPropagation()}>
            <div className="px-6 py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold">Log transaction</div>
            <div className="p-6 space-y-3">
              <div className="text-sm text-slate-600">Item</div>
              <div className="font-medium">{item.name}</div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="text-sm text-slate-600">Type</label>
                  <Select value={type} onChange={setType}>
                    <option value="sale">Sale</option>
                    <option value="purchase">Purchase</option>
                  </Select>
                </div>
                <div>
                  <label className="text-sm text-slate-600">Qty</label>
                  <Input type="number" value={qty} onChange={e=>setQty(Number(e.target.value)||0)} />
                </div>
              </div>
              <div>
                <label className="text-sm text-slate-600">Unit price (USD)</label>
                <Input type="number" value={price} onChange={e=>setPrice(e.target.value)} />
              </div>
              <div>
                <label className="text-sm text-slate-600">Note (optional)</label>
                <Input value={note} onChange={e=>setNote(e.target.value)} placeholder="e.g. cash, customer name…" />
              </div>
            </div>
            <div className="px-6 py-4 border-t flex justify-end gap-2">
              <Button variant="secondary" onClick={onClose} disabled={busy}>Cancel</Button>
              <Button onClick={submit} disabled={busy}>{busy?"Saving…":"Save"}</Button>
            </div>
          </div>
        </div>
      );
    }

    // Mount
    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>
</body>
</html>
